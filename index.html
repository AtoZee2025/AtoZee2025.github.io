<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Wedding Seating Chart</title>
  <meta name="theme-color" content="#ffffff">
  <style>
    :root{
      --bg:#f7f7fb; --card:#ffffff; --ink:#111827; --muted:#6b7280;
      --accent:#4f46e5; --accent-ink:#ffffff; --radius:16px; --shadow:0 10px 20px -10px rgba(0,0,0,.2);
      --chip-bg:#f3f4f6; --chip-ink:#374151; --badge-bg:#eef2ff; --badge-ink:#3730a3;
    }
    *{box-sizing:border-box} html,body{height:100%}
    body{ margin:0; font-family: ui-sans-serif, system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial; background:var(--bg); color:var(--ink); }
    .container{max-width:960px;margin:0 auto;padding:24px}
    .app{ background:var(--card); border-radius:var(--radius); box-shadow:var(--shadow); padding:clamp(16px,4vw,28px) }
    header{ display:flex; flex-wrap:wrap; gap:12px; align-items:center; justify-content:space-between; margin-bottom:16px }
    .brand{ display:flex; gap:12px; align-items:center }
    .brand .emoji{ font-size:28px }
    .brand h1{ font-size:18px; margin:0; line-height:1.2 }
    .brand p{ margin:0; color:var(--muted); font-size:12px }
    input[type="search"]{ width:100%; padding:14px 16px; border-radius:12px; border:1px solid #e5e7eb; font-size:16px; outline:none }
    .hint{ color:var(--muted); font-size:12px }
    .results{ margin-top:14px; display:grid; grid-template-columns:repeat(auto-fill,minmax(280px,1fr)); gap:12px }
    .card{ border:1px solid #e5e7eb; border-radius:14px; background:#fff; padding:14px; display:flex; flex-direction:column; gap:8px; cursor:pointer; opacity:0; transform:translateY(6px); animation:cardIn .35s both; }
    .card:nth-child(2){ animation-delay:.04s } .card:nth-child(3){ animation-delay:.08s } .card:nth-child(4){ animation-delay:.12s }
    @keyframes cardIn{ to{ opacity:1; transform:none } }
    .name{ font-weight:700; font-size:16px }
    .meta{ color:var(--muted); font-size:12px }
    .badge{ font-size:12px; padding:4px 8px; border-radius:999px; background:var(--badge-bg); color:var(--badge-ink); display:inline-block }
    .footer{ margin-top:18px; color:var(--muted); font-size:12px; text-align:center }

    .detail{ position:fixed; inset:0; background:rgba(17,24,39,.5); display:none; align-items:center; justify-content:center; padding:16px }
    .detail.open{ display:flex }
    .sheet{ width:min(640px,100%); background:#fff; border-radius:16px; padding:18px; border:1px solid #e5e7eb; box-shadow:var(--shadow); max-height:90vh; overflow:auto }
    .sheet h2{ margin:0 0 8px 0 }
    .sheet .table{ font-weight:700; font-size:18px }
    .sheet .sub{ color:var(--muted); font-size:13px; margin-bottom:8px }
    .sheet .close{ float:right }
    .divider{ height:1px; background:#e5e7eb; margin:10px 0 }
    .hidden{ display:none }

    .chips{ display:flex; flex-wrap:wrap; gap:8px; margin-top:8px }
    .chip{ background:var(--chip-bg); color:var(--chip-ink); padding:6px 10px; border-radius:999px; font-size:12px; }

    /* Vertical list of tablemates */
    .matesList{ list-style:none; padding:0; margin:8px 0 0 0; display:flex; flex-direction:column; gap:8px; }
    .mateRow{ display:flex; align-items:center; gap:10px; padding:8px 10px; background:#f9fafb; border:1px solid #e5e7eb; border-radius:10px; }
    .mateName{ font-size:14px; font-weight:600; }
  </style>
</head>
<body>
  <div class="container">
    <div class="app" role="application" aria-label="Wedding seating chart">
      <header>
        <div class="brand">
          <div class="emoji" aria-hidden="true">ðŸ’’</div>
          <div>
            <h1 id="eventTitle">Wedding Seating Chart</h1>
            <p id="eventSub" class="hint">Type your name to find your table âœ¨</p>
          </div>
        </div>
      </header>

      <div class="row">
        <input id="search" type="search" inputmode="search" aria-label="Search guests" placeholder="Search for your nameâ€¦" autofocus />
      </div>
      <div id="status" class="hint" style="margin-top:6px;"></div>

      <div id="results" class="results" role="list"></div>

      <div class="footer">
        <div class="hint" style="margin-top:8px">
          Privacy note: results appear only after you start typing. The panel opens automatically when we find a unique match.
        </div>
      </div>
    </div>
  </div>

  <div class="detail" id="detail" role="dialog" aria-modal="true" aria-labelledby="detailTitle">
    <div class="sheet">
      <button class="close" id="closeDetail" aria-label="Close">âœ•</button>
      <h2 id="detailTitle">Guest</h2>
      <div class="sub" id="detailSub"></div>
      <div class="divider"></div>

      <div class="table">Table: <span id="detailTable"></span></div>
      <div class="chips" id="detailChips"></div>

      <div class="divider"></div>
      <div>
        <strong>Photo Group</strong>
        <div id="detailPhotoGroup" class="chips" style="margin-top:8px;"></div>
      </div>

      <div class="divider"></div>
      <div>
        <strong>Who Am I Sitting With</strong>
        <ul id="matesList" class="matesList"></ul>
      </div>
    </div>
  </div>

  <script>
    /* ===== CSV helpers (robust) ===== */
    function detectDelimiter(firstLine){
      const candidates = [',',';','\t'];
      let best = ',', bestCount = -1;
      for(const d of candidates){
        const c = (firstLine.match(new RegExp('\\' + d, 'g')) || []).length;
        if(c > bestCount){ best = d; bestCount = c; }
      }
      return best;
    }
    function parseCSVSmart(text){
      if (text.charCodeAt(0) === 0xFEFF) text = text.slice(1);
      text = text.replace(/\r\n/g, '\n').replace(/\r/g, '\n');
      const lines = text.split('\n').filter(l => l.trim().length);
      if(lines.length === 0) return [];
      const delim = detectDelimiter(lines[0]);
      const parseLine = (line) => {
        const out = []; let cur = '', inQ = false;
        for(let i=0;i<line.length;i++){
          const ch = line[i];
          if(ch === '"'){
            if(inQ && line[i+1] === '"'){ cur += '"'; i++; }
            else inQ = !inQ;
          }else if(ch === delim && !inQ){
            out.push(cur); cur = '';
          }else{
            cur += ch;
          }
        }
        out.push(cur);
        return out.map(s => s.trim());
      };
      const rows = lines.map(parseLine).filter(r => r.some(x => (x||'').length));
      return rows;
    }
    function csvToGuests(text){
      const rows = parseCSVSmart(text);
      if(rows.length === 0) return [];
      const header = rows[0].map(h => (h||'').toLowerCase());
      const idx = k => header.indexOf(k.toLowerCase());
      const pick = (r, keys) => {
        for(const k of keys){ const i = idx(k); if(i>-1) return r[i]||''; }
        return '';
      };
      const mapped = rows.slice(1).map(r => ({
        name:  pick(r, ['name','guest','full name']),
        table: pick(r, ['table','assignment','table name']),
        photo_group: pick(r, ['photo group','photogroup','photo_group','photogroup','group'])
      })).filter(g => g.name);
      return mapped;
    }

    // OPTIONAL: fallback list if CSV is missing
    const EMBEDDED = [];

    // --- DOM utils & state ---
    const $ = sel => document.querySelector(sel);
    const norm = s => (s||"").toString().toLowerCase().normalize('NFD').replace(/\p{Diacritic}/gu,'').replace(/\s+/g,' ').trim();
    const debounce = (fn, ms=150) => { let t; return (...args)=>{ clearTimeout(t); t=setTimeout(()=>fn(...args), ms); }; };
    let GUESTS = [];
    let FILTERED = [];
    let HAS_SEARCHED = false;
    let CSV_LOADED = false;
    let LAST_OPENED = null;

    // --- Render list ---
    function render(){
      const list = $("#results"); list.innerHTML="";
      if(!HAS_SEARCHED){ return; }
      FILTERED.forEach(g=>{
        const card = document.createElement('div');
        card.className = 'card'; card.setAttribute('role','listitem');
        card.onclick = ()=> openDetail(g.id);
        const name = Object.assign(document.createElement('div'), {className:'name', textContent:g.name});
        const meta = document.createElement('div'); meta.className='meta';
        const bits = [];
        if(g.photo_group) bits.push("Photo Group: " + g.photo_group);
        meta.textContent = bits.join(" â€¢ ");
        const row = Object.assign(document.createElement('div'), {className:'row'});
        const b1 = Object.assign(document.createElement('span'), {className:'badge', textContent: g.table || "Unassigned"});
        row.appendChild(b1);
        card.appendChild(name);
        if(meta.textContent) card.appendChild(meta);
        card.appendChild(row);
        list.appendChild(card);
      });
    }

    // --- Detail modal ---
    function openDetail(id){
      const g = GUESTS.find(x=>x.id===id); if(!g) return;
      $("#detailTitle").textContent = g.name;
      $("#detailSub").textContent = ""; // we won't repeat photo group here
      $("#detailTable").textContent = g.table || "Unassigned";

      // Chips (table only, keep it simple)
      const chips = $("#detailChips"); chips.innerHTML = "";
      const chip = (t)=>{ const s=document.createElement('span'); s.className='chip'; s.textContent=t; return s; };
      if(g.table) chips.appendChild(chip(g.table));

      // Dedicated Photo Group section
      const pg = $("#detailPhotoGroup"); pg.innerHTML = "";
      if (g.photo_group){
        pg.appendChild(chip(g.photo_group));
      } else {
        const none = document.createElement('span');
        none.className = 'chip';
        none.textContent = "â€”";
        pg.appendChild(none);
      }

      // Tablemates list (vertical) â€” names only, no photo group
      const list = $("#matesList"); list.innerHTML = "";
      const mates = GUESTS
        .filter(x => norm(x.table) === norm(g.table) && norm(x.name) !== norm(g.name))
        .sort((a,b)=> a.name.localeCompare(b.name));

      if(mates.length){
        mates.forEach(m => {
          const li = document.createElement('li');
          li.className = 'mateRow';
          const nm = document.createElement('div'); nm.className='mateName'; nm.textContent = m.name;
          li.appendChild(nm);
          list.appendChild(li);
        });
      }else{
        const li = document.createElement('li');
        li.className = 'mateRow';
        const nm = document.createElement('div'); nm.className='meta';
        nm.textContent = "No other guests listed at this table yet.";
        li.appendChild(nm);
        list.appendChild(li);
      }

      $("#detail").classList.add('open');
    }
    function closeDetail(){ $("#detail").classList.remove('open'); }
    $("#closeDetail").onclick = closeDetail;
    $("#detail").addEventListener('click', (e)=>{ if(e.target.id==="detail") closeDetail(); });

    // --- Search ---
    async function onSearchInput(e){
      const s = $("#status");
      const q = e.target.value;
      if(!CSV_LOADED){
        if(s) s.textContent = 'Loading guests.csvâ€¦';
        const ok = await tryAutoLoad();
        CSV_LOADED = ok;
        if(s) s.textContent = ok ? '' : 'Using embedded list (no CSV found).';
      }
      applyFilter(q);
    }
    $("#search").addEventListener('input', debounce(onSearchInput, 120));

    function applyFilter(q){
      const nq = norm(q);

      if(!nq){
        HAS_SEARCHED = false;
        FILTERED = [];
        LAST_OPENED = null;
        const isOpen = $("#detail")?.classList.contains('open');
        if(isOpen) closeDetail();
        render();
        return;
      }

      HAS_SEARCHED = true;
      FILTERED = GUESTS.filter(g=>{
        const hay = [g.name, g.table, g.photo_group].map(norm).join(" ");
        return nq.split(" ").every(tok=> hay.includes(tok));
      });

      render();

      // Auto-open when there's exactly one match
      if(FILTERED.length === 1){
        const only = FILTERED[0];
        if(LAST_OPENED !== only.id){
          LAST_OPENED = only.id;
          setTimeout(()=> openDetail(only.id), 120);
        }
      }else{
        const isOpen = $("#detail")?.classList.contains('open');
        if(isOpen) closeDetail();
        LAST_OPENED = null;
      }
    }

    // --- Loaders ---
    function loadGuests(items){
      GUESTS = items.map(g=>({ ...g, id: norm(g.name + '|' + (g.table||'')) }));
      // Don't render until user types
    }

    async function tryAutoLoad(){
      try{
        const res = await fetch('guests.csv', { cache: 'no-store' });
        if(!res.ok) return false;
        const text = await res.text();
        const guests = csvToGuests(text);
        if(guests.length === 0) return false;
        loadGuests(guests);
        return true;
      }catch(err){
        return false;
      }
    }

    // --- Boot (wait for first keystroke) ---
    (function init(){
      if($("#status")) $("#status").textContent = "Start typing your nameâ€¦";
      if(EMBEDDED.length){ loadGuests(EMBEDDED); }
      setTimeout(()=> $("#search").focus(), 300);
    })();
  </script>
</body>
</html>